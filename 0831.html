<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>共享式聯絡簿</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, addDoc, updateDoc, deleteDoc, onSnapshot, query, where, Timestamp, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        setLogLevel('debug');

        // 使用平台提供的 Firebase 配置
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        let userId = null;
        let userName = null; // 新增使用者名稱變數
        let selectedReminder = null;
        let isEditing = false;
        
        // 獲取 Firestore 集合路徑
        const getCollectionRef = (isPrivate) => {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const userUid = auth.currentUser?.uid || crypto.randomUUID();
            const collectionPath = isPrivate
                ? `/artifacts/${appId}/users/${userUid}/reminders`
                : `/artifacts/${appId}/public/data/reminders`;
            return collection(db, collectionPath);
        };
        
        // 獲取使用者個人資料文件引用
        const getUserProfileRef = (uid) => {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            return doc(db, `/artifacts/${appId}/users/${uid}/profile/settings`);
        };

        // 顯示通知
        const showNotification = (message, colorClass = 'bg-gray-500') => {
            const notificationContainer = document.getElementById('notificationContainer');
            const notification = document.createElement('div');
            notification.className = `p-4 rounded-md shadow-lg text-white font-medium mb-2 ${colorClass} transition-opacity duration-300 opacity-0`;
            notification.textContent = message;
            notificationContainer.appendChild(notification);
            
            setTimeout(() => notification.classList.remove('opacity-0'), 100);
            setTimeout(() => {
                notification.classList.add('opacity-0');
                notification.addEventListener('transitionend', () => notification.remove());
            }, 3000);
        };
        
        // 渲染清單項目
        const renderChecklistItems = (checklist) => {
            const checklistItemsContainer = document.getElementById('checklistItems');
            checklistItemsContainer.innerHTML = '';
            if (!checklist || checklist.length === 0) {
                checklistItemsContainer.innerHTML = '<p class="text-gray-500">此提醒事項沒有清單項目。</p>';
                return;
            }
            checklist.forEach((item, index) => {
                const itemEl = document.createElement('div');
                itemEl.className = 'flex items-center justify-between p-2 rounded-md transition-colors duration-200 hover:bg-gray-100';
                itemEl.innerHTML = `
                    <div class="flex items-center flex-grow">
                        <input type="checkbox" class="form-checkbox h-5 w-5 text-indigo-600 rounded-full" ${item.completed ? 'checked' : ''}>
                        <span class="ml-3 text-gray-800 flex-grow ${item.completed ? 'line-through text-gray-400' : ''}">${item.text}</span>
                        ${item.time ? `<span class="ml-auto text-gray-500 text-sm flex-shrink-0">${item.time}</span>` : ''}
                    </div>
                    <div class="flex-shrink-0 flex space-x-2 ml-4">
                        <button class="edit-item-btn text-blue-500 hover:text-blue-700">編輯</button>
                        <button class="delete-item-btn text-red-500 hover:text-red-700">刪除</button>
                    </div>
                `;
                
                // 處理完成狀態切換
                itemEl.querySelector('input[type="checkbox"]').addEventListener('change', async (e) => {
                    const updatedChecklist = [...selectedReminder.checklist];
                    updatedChecklist[index].completed = e.target.checked;
                    try {
                        const reminderRef = doc(db, getCollectionRef(selectedReminder.isPrivate).path, selectedReminder.id);
                        await updateDoc(reminderRef, { checklist: updatedChecklist });
                    } catch (e) {
                        console.error("更新清單項目失敗: ", e);
                        showNotification("更新清單項目失敗。", 'bg-red-500');
                    }
                });
                
                // 處理刪除
                itemEl.querySelector('.delete-item-btn').addEventListener('click', async () => {
                    const updatedChecklist = selectedReminder.checklist.filter((_, i) => i !== index);
                    try {
                        const reminderRef = doc(db, getCollectionRef(selectedReminder.isPrivate).path, selectedReminder.id);
                        await updateDoc(reminderRef, { checklist: updatedChecklist });
                        showNotification("清單項目已刪除。", 'bg-green-500');
                    } catch (e) {
                        console.error("刪除清單項目失敗: ", e);
                        showNotification("刪除清單項目失敗。", 'bg-red-500');
                    }
                });
                
                // 處理編輯
                itemEl.querySelector('.edit-item-btn').addEventListener('click', () => {
                    const newText = prompt("編輯清單項目:", item.text);
                    if (newText !== null && newText.trim() !== "") {
                        const newTime = prompt("編輯清單時間 (HH:MM):", item.time || "");
                        const updatedChecklist = [...selectedReminder.checklist];
                        updatedChecklist[index].text = newText.trim();
                        updatedChecklist[index].time = newTime ? newTime.trim() : null;

                        updateDoc(doc(db, getCollectionRef(selectedReminder.isPrivate).path, selectedReminder.id), { checklist: updatedChecklist })
                            .then(() => {
                                showNotification("清單項目已更新。", 'bg-green-500');
                            })
                            .catch((e) => {
                                console.error("編輯清單項目失敗: ", e);
                                showNotification("編輯清單項目失敗。", 'bg-red-500');
                            });
                    }
                });
                
                checklistItemsContainer.appendChild(itemEl);
            });
        };
        
        // 渲染提醒事項列表
        const renderReminders = (reminders) => {
            const reminderList = document.getElementById('reminderList');
            reminderList.innerHTML = '';
            if (reminders.length === 0) {
                reminderList.innerHTML = '<p class="text-gray-500 text-center">目前沒有任何提醒事項。</p>';
                return;
            }
            reminders.forEach(reminder => {
                const reminderEl = document.createElement('div');
                const isPrivate = reminder.isPrivate;
                const isOwner = reminder.createdBy === userName || reminder.createdBy === userId; // 檢查是否為創建者
                
                reminderEl.className = 'bg-white rounded-xl shadow-md p-6 mb-4 flex flex-col justify-between transition-transform duration-200 hover:scale-105';
                reminderEl.innerHTML = `
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-lg font-bold text-gray-800">${reminder.title}</h3>
                        <span class="text-xs font-semibold px-2 py-1 rounded-full ${isPrivate ? 'bg-indigo-100 text-indigo-700' : 'bg-green-100 text-green-700'}">
                            ${isPrivate ? '私人' : '共享'}
                        </span>
                    </div>
                    <p class="text-sm text-gray-600 mb-2">${reminder.content || ''}</p>
                    <div class="text-xs text-gray-500 mb-2">
                        <p>日期：${reminder.date.toDate().toLocaleDateString()}</p>
                        <p>標籤：${reminder.tags.length > 0 ? reminder.tags.join(', ') : '無'}</p>
                        <p>緊急程度：${reminder.urgency}</p>
                        <p>創建者：${reminder.createdBy}</p>
                    </div>
                    <div class="flex justify-end space-x-2 mt-4">
                        <button class="view-checklist-btn bg-gray-200 text-gray-700 px-3 py-1 rounded-full text-sm font-medium hover:bg-gray-300">
                            清單 (${reminder.checklist ? reminder.checklist.length : 0})
                        </button>
                        ${isOwner ? `
                        <button class="edit-btn bg-blue-500 text-white px-3 py-1 rounded-full text-sm font-medium hover:bg-blue-600">編輯</button>
                        <button class="delete-btn bg-red-500 text-white px-3 py-1 rounded-full text-sm font-medium hover:bg-red-600">刪除</button>
                        ` : ''}
                    </div>
                `;
                
                // 處理檢視清單
                reminderEl.querySelector('.view-checklist-btn').addEventListener('click', () => {
                    const checklistModal = document.getElementById('checklistModal');
                    const checklistTitle = document.getElementById('checklistTitle');
                    selectedReminder = reminder;
                    checklistTitle.textContent = `清單: ${selectedReminder.title}`;
                    renderChecklistItems(selectedReminder.checklist);
                    checklistModal.classList.remove('hidden');
                });
                
                // 處理編輯
                if (isOwner) {
                    reminderEl.querySelector('.edit-btn').addEventListener('click', () => {
                        const reminderModal = document.getElementById('reminderModal');
                        selectedReminder = reminder;
                        isEditing = true;
                        document.getElementById('titleInput').value = reminder.title;
                        document.getElementById('contentInput').value = reminder.content || '';
                        document.getElementById('tagsInput').value = reminder.tags.join(', ');
                        document.getElementById('dateInput').value = reminder.date.toDate().toISOString().split('T')[0];
                        document.getElementById('urgencyInput').value = reminder.urgency;
                        document.getElementById('isPrivateInput').checked = reminder.isPrivate;
                        document.getElementById('reminderModalTitle').textContent = '編輯提醒事項';
                        reminderModal.classList.remove('hidden');
                    });
                    
                    // 處理刪除
                    reminderEl.querySelector('.delete-btn').addEventListener('click', async () => {
                        try {
                            const reminderRef = doc(db, getCollectionRef(isPrivate).path, reminder.id);
                            await deleteDoc(reminderRef);
                            showNotification("提醒事項已刪除。", 'bg-green-500');
                        } catch (e) {
                            console.error("刪除提醒事項失敗: ", e);
                            showNotification("刪除提醒事項失敗。", 'bg-red-500');
                        }
                    });
                }
                
                reminderList.appendChild(reminderEl);
            });
        };
        
        // 頁面載入時的初始化
        window.onload = () => {
            const userNameInput = document.getElementById('userNameInput');
            const saveNameBtn = document.getElementById('saveNameBtn');
            const userDisplay = document.getElementById('userDisplay');
            const addReminderBtn = document.getElementById('addReminderBtn');
            const reminderModal = document.getElementById('reminderModal');
            const checklistModal = document.getElementById('checklistModal');
            const reminderForm = document.getElementById('reminderForm');
            const saveChecklistItemBtn = document.getElementById('saveChecklistItemBtn');
            const newChecklistItemInput = document.getElementById('newChecklistItemInput');
            const newChecklistItemTimeInput = document.getElementById('newChecklistItemTimeInput');
            
            // 使用 onAuthStateChanged 監聽登入狀態
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    userDisplay.textContent = `您的使用者 ID: ${userId}`;
                    
                    // 獲取並顯示使用者名稱
                    const userProfileDoc = await getDoc(getUserProfileRef(userId));
                    if (userProfileDoc.exists()) {
                        userName = userProfileDoc.data().name || userId;
                        userNameInput.value = userName === userId ? '' : userName; // 如果名稱是ID，顯示為空
                    } else {
                        userName = userId;
                        userNameInput.value = '';
                    }

                } else {
                    try {
                        const customToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                        if (customToken) {
                            await signInWithCustomToken(auth, customToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (e) {
                        console.error("登入失敗: ", e);
                    }
                }
                
                // 無論登入狀態如何，都開始監聽 Firestore 資料
                const publicQuery = query(getCollectionRef(false));
                onSnapshot(publicQuery, (querySnapshot) => {
                    const publicReminders = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    const allReminders = [...publicReminders];
                    
                    if (userId) {
                        const privateQuery = query(getCollectionRef(true), where("createdBy", "==", userId));
                        onSnapshot(privateQuery, (privateSnapshot) => {
                            const privateReminders = privateSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            const combinedReminders = [...publicReminders, ...privateReminders];
                            combinedReminders.sort((a, b) => b.date.toDate() - a.date.toDate());
                            renderReminders(combinedReminders);
                        });
                    } else {
                        renderReminders(allReminders);
                    }
                });
            });

            // 儲存使用者名稱
            saveNameBtn.addEventListener('click', async () => {
                const newName = userNameInput.value.trim() || userId;
                if (!userId) {
                    showNotification("請先登入以儲存您的名稱。", 'bg-red-500');
                    return;
                }
                try {
                    await setDoc(getUserProfileRef(userId), { name: newName }, { merge: true });
                    userName = newName;
                    showNotification("名稱已成功儲存。", 'bg-green-500');
                } catch (e) {
                    console.error("儲存名稱失敗: ", e);
                    showNotification("儲存名稱失敗。", 'bg-red-500');
                }
            });

            // 儲存/更新提醒事項
            reminderForm.addEventListener('submit', async (e) => {
                e.preventDefault();
            
                const title = document.getElementById('titleInput').value;
                const content = document.getElementById('contentInput').value;
                const tags = document.getElementById('tagsInput').value.split(',').map(tag => tag.trim()).filter(tag => tag !== '');
                const date = document.getElementById('dateInput').value;
                const urgency = document.getElementById('urgencyInput').value;
                const isPrivate = document.getElementById('isPrivateInput').checked;
            
                const reminderDate = Timestamp.fromDate(new Date(`${date}T00:00:00`)); // 僅使用日期

                const creator = userName || userId;

                const reminderData = {
                    title, content, tags, date: reminderDate, urgency, isPrivate, createdBy: creator,
                    checklist: isEditing ? selectedReminder.checklist : []
                };
            
                try {
                    if (isEditing && selectedReminder) {
                        const reminderRef = doc(db, getCollectionRef(selectedReminder.isPrivate).path, selectedReminder.id);
                        await updateDoc(reminderRef, reminderData);
                        showNotification("提醒事項已成功更新。", 'bg-green-500');
                    } else {
                        await addDoc(getCollectionRef(isPrivate), reminderData);
                        showNotification("提醒事項已成功新增。", 'bg-green-500');
                    }
                    reminderModal.classList.add('hidden');
                    reminderForm.reset();
                } catch (e) {
                    console.error("儲存提醒事項失敗: ", e);
                    showNotification("儲存提醒事項失敗。", 'bg-red-500');
                }
            });
            
            // 儲存清單項目
            saveChecklistItemBtn.addEventListener('click', async () => {
                const newItemText = newChecklistItemInput.value.trim();
                const newItemTime = newChecklistItemTimeInput.value.trim();
                if (newItemText.length === 0 || !selectedReminder) return;
            
                const newItem = { text: newItemText, completed: false, time: newItemTime || null };
                const updatedChecklist = [...(selectedReminder.checklist || []), newItem];
            
                try {
                    const reminderRef = doc(db, getCollectionRef(selectedReminder.isPrivate).path, selectedReminder.id);
                    await updateDoc(reminderRef, { checklist: updatedChecklist });
                    showNotification("清單項目已新增。", 'bg-green-500');
                    newChecklistItemInput.value = '';
                    newChecklistItemTimeInput.value = '';
                } catch (e) {
                    console.error("新增清單項目失敗: ", e);
                    showNotification("新增清單項目失敗。", 'bg-red-500');
                }
            });
            
            // UI 事件監聽
            addReminderBtn.addEventListener('click', () => {
                isEditing = false;
                selectedReminder = null;
                document.getElementById('reminderModalTitle').textContent = '新增提醒事項';
                reminderForm.reset();
                reminderModal.classList.remove('hidden');
            });
            
            document.querySelectorAll('.close-modal-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    reminderModal.classList.add('hidden');
                    checklistModal.classList.add('hidden');
                });
            });
            
            // 阻止點擊 Modal 內容時關閉
            document.getElementById('reminderModalContent').addEventListener('click', e => e.stopPropagation());
            document.getElementById('checklistModalContent').addEventListener('click', e => e.stopPropagation());
        };

    </script>
</head>
<body style="font-family: 'Inter', sans-serif;" class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-4xl font-bold text-gray-900">共享式聯絡簿</h1>
            <button id="addReminderBtn" class="bg-indigo-600 text-white px-6 py-2 rounded-full font-semibold shadow-lg hover:bg-indigo-700 transition-colors duration-200">
                新增提醒事項
            </button>
        </div>
        
        <!-- 使用者設定區塊 -->
        <div class="bg-white rounded-xl shadow-md p-6 mb-4">
            <h2 class="text-xl font-bold text-gray-800 mb-4">我的設定</h2>
            <div class="flex items-center space-x-4">
                <div class="flex-1">
                    <label for="userNameInput" class="block text-gray-700 font-medium">您的名稱 (選填)</label>
                    <input type="text" id="userNameInput" placeholder="輸入您的名稱..." class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                </div>
                <button id="saveNameBtn" class="bg-blue-500 text-white px-4 py-2 rounded-full font-semibold hover:bg-blue-600 transition-colors duration-200">
                    儲存名稱
                </button>
            </div>
            <div id="userDisplay" class="text-sm text-gray-600 mt-4 font-medium"></div>
        </div>

        <div id="reminderList">
            <!-- 提醒事項會在這裡動態載入 -->
        </div>
    </div>
    
    <!-- 提醒事項 Modal -->
    <div id="reminderModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50">
        <div id="reminderModalContent" class="relative bg-white p-8 rounded-xl shadow-2xl max-w-md w-full m-4 transform transition-transform duration-300 scale-95">
            <h2 id="reminderModalTitle" class="text-2xl font-bold mb-6 text-gray-800"></h2>
            <form id="reminderForm" class="space-y-4">
                <div>
                    <label class="block text-gray-700 font-medium">標題</label>
                    <input type="text" id="titleInput" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                </div>
                <div>
                    <label class="block text-gray-700 font-medium">內容 (選填)</label>
                    <textarea id="contentInput" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"></textarea>
                </div>
                <div class="grid grid-cols-1 gap-4">
                    <div>
                        <label class="block text-gray-700 font-medium">日期</label>
                        <input type="date" id="dateInput" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                    </div>
                </div>
                <div>
                    <label class="block text-gray-700 font-medium">標籤 (用逗號分隔)</label>
                    <input type="text" id="tagsInput" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                </div>
                <div>
                    <label class="block text-gray-700 font-medium">緊急程度</label>
                    <select id="urgencyInput" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                        <option value="低">低</option>
                        <option value="中">中</option>
                        <option value="高">高</option>
                    </select>
                </div>
                <div class="flex items-center">
                    <input type="checkbox" id="isPrivateInput" class="form-checkbox h-4 w-4 text-indigo-600 rounded">
                    <label for="isPrivateInput" class="ml-2 text-gray-700 font-medium">設為私人 (僅您可見)</label>
                </div>
                <div class="flex justify-end space-x-4 mt-6">
                    <button type="button" class="close-modal-btn bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-full hover:bg-gray-300">取消</button>
                    <button type="submit" class="bg-indigo-600 text-white font-bold py-2 px-6 rounded-full hover:bg-indigo-700 transition-colors duration-200">儲存</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- 清單 Modal -->
    <div id="checklistModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50">
        <div id="checklistModalContent" class="relative bg-white p-8 rounded-xl shadow-2xl max-w-md w-full m-4 transform transition-transform duration-300 scale-95">
            <h2 id="checklistTitle" class="text-2xl font-bold mb-6 text-gray-800"></h2>
            
            <div id="checklistItems" class="space-y-3 mb-6">
                <!-- 清單項目會在這裡動態載入 -->
            </div>
            
            <div class="grid grid-cols-2 gap-2 mt-4">
                <input type="text" id="newChecklistItemInput" placeholder="新增清單項目..." class="rounded-md border-gray-300 shadow-sm p-2 focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                <input type="time" id="newChecklistItemTimeInput" class="rounded-md border-gray-300 shadow-sm p-2 focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
            </div>
            <div class="flex justify-end mt-4 space-x-2">
                <button id="saveChecklistItemBtn" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-full hover:bg-indigo-700 transition-colors duration-200">
                    新增
                </button>
                <button type="button" class="close-modal-btn bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-full hover:bg-gray-300">關閉</button>
            </div>
        </div>
    </div>

    <!-- 通知容器 -->
    <div id="notificationContainer" class="fixed top-4 right-4 z-50"></div>
</body>
</html>
